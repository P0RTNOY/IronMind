services:
  mailpit:
    image: axllent/mailpit:latest
    ports:
      - "8025:8025" # Web UI
      - "1025:1025" # SMTP
    restart: unless-stopped

  firestore:
    image: google/cloud-sdk:525.0.0
    environment:
      PROJECT_ID: ${PROJECT_ID}
    command: >
      bash -lc "gcloud config set project ${PROJECT_ID} && gcloud beta emulators firestore start --host-port=0.0.0.0:8080 --project=${PROJECT_ID} --quiet"
    ports:
      - "8081:8080"

  api:
    build:
      context: .
      target: dev
    depends_on:
      - firestore
      - mailpit
    volumes:
      - .:/app
      - ./secrets/firebase_sa.json:/secrets/firebase_sa.json:ro
      - ./secrets/ironmind-486909-5f60a6da2bd6.json:/secrets/ironmind-486909-5f60a6da2bd6.json:ro
    environment:
      # App
      ENV: "dev"
      PROJECT_ID: ${PROJECT_ID}
      GOOGLE_CLOUD_PROJECT: ${PROJECT_ID}
      FRONTEND_ORIGIN: "http://localhost:3000"
      APP_VERSION: "local"

      # IMPORTANT: tell Firestore client to use emulator
      # FIRESTORE_EMULATOR_HOST: "firestore:8080"

      # Google Auth
      GOOGLE_APPLICATION_CREDENTIALS: "/secrets/ironmind-486909-5f60a6da2bd6.json"

      # Admin
      ADMIN_UIDS: ${ADMIN_UIDS:-[]}

      # Stripe
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_PRICE_ID_FUNDAMENTALS_ONE_TIME: ${STRIPE_PRICE_ID_FUNDAMENTALS_ONE_TIME:-}
      STRIPE_PRICE_ID_MEMBERSHIP_MONTHLY: ${STRIPE_PRICE_ID_MEMBERSHIP_MONTHLY:-}
      CHECKOUT_SUCCESS_URL: "http://localhost:3000/success?session_id={CHECKOUT_SESSION_ID}"
      CHECKOUT_CANCEL_URL: "http://localhost:3000/cancel"
      GCS_BUCKET_NAME: "ironmind-uploads-dev-123"

      # Firebase Admin:
      # Keep base64 empty. (We’ll deal with tokens in “Auth testing” below.)
      FIREBASE_ADMIN_SDK_JSON_BASE64: ""
      FIREBASE_PROJECT_ID: ${PROJECT_ID}

      # Email (Mailpit in dev, Resend in prod)
      SMTP_HOST: "mailpit"
      SMTP_PORT: "1025"
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: "Iron Mind <noreply@ironmind.app>"

    ports:
      - "8080:8080"

  web:
    build:
      context: ../web
      dockerfile: Dockerfile
      target: dev
    ports:
      - "3000:3000"
    volumes:
      - ../web:/app
      - /app/node_modules
    environment:
      - VITE_API_BASE_URL=/api
      - VITE_API_PROXY_TARGET=http://api:8080
